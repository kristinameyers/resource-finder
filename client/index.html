<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Santa Barbara 211 Resource Finder</title>
  <script src="zipCodeData.js"></script>
  <script>
    // Ensure functions from zipCodeData.js are available globally
    if (typeof window.calculateZipCodeDistance === 'undefined' && typeof calculateZipCodeDistance !== 'undefined') {
      window.calculateZipCodeDistance = calculateZipCodeDistance;
    }
    if (typeof window.normalizeZipCode === 'undefined' && typeof normalizeZipCode !== 'undefined') {
      window.normalizeZipCode = normalizeZipCode;
    }
  </script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    header {
      text-align: center;
      color: white;
      padding: 40px 0;
    }
    
    header h1 {
      font-size: 3em;
      margin-bottom: 10px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }
    
    header p {
      font-size: 1.2em;
      opacity: 0.95;
    }
    
    .search-box {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      margin-bottom: 30px;
    }
    
    .search-box input {
      width: 100%;
      padding: 15px;
      font-size: 16px;
      border: 2px solid #e0e0e0;
      border-radius: 5px;
      transition: border-color 0.3s;
    }
    
    .search-box input:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .categories {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
    }
    
    .category-card {
      background: white;
      padding: 20px 15px;
      border-radius: 10px;
      text-align: center;
      cursor: pointer;
      transition: transform 0.3s, box-shadow 0.3s;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .category-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    }
    
    .category-card.active {
      background: #667eea;
      color: white;
    }
    
    .category-icon {
      font-size: 2em;
      margin-bottom: 8px;
    }
    
    .category-name {
      font-size: 1em;
      font-weight: bold;
      margin-bottom: 5px;
      line-height: 1.2;
    }
    
    .category-description {
      font-size: 0.85em;
      opacity: 0.8;
      line-height: 1.2;
    }
    
    .resources {
      display: grid;
      gap: 20px;
    }
    
    .resource-card {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      transition: transform 0.3s, box-shadow 0.3s;
      margin-bottom: 15px;
    }
    
    .resource-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 25px rgba(0,0,0,0.15);
    }
    
    .resource-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 15px;
    }
    
    .resource-name {
      font-size: 1.3em;
      font-weight: bold;
      color: #005191;
      cursor: pointer;
      text-decoration: underline;
      transition: color 0.2s;
      margin-bottom: 10px;
    }
    
    .resource-name:hover {
      color: #667eea;
    }
    
    .resource-category {
      background: #667eea;
      color: white;
      padding: 5px 15px;
      border-radius: 20px;
      font-size: 0.9em;
    }
    
    .resource-description {
      color: #000000;
      line-height: 1.6;
      font-size: 14px;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      margin: 0;
    }
    
    .resource-details {
      display: grid;
      gap: 10px;
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid #e0e0e0;
    }
    
    .resource-detail {
      display: flex;
      align-items: center;
      gap: 10px;
      color: #555;
    }
    
    .resource-detail-icon {
      width: 20px;
      text-align: center;
      color: #667eea;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: white;
      font-size: 1.2em;
    }
    
    .error {
      background: #ff6b6b;
      color: white;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      margin: 20px 0;
    }
    
    .no-results {
      background: white;
      padding: 40px;
      border-radius: 10px;
      text-align: center;
      color: #666;
    }
    
    .subcategories {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
      animation: slideIn 0.3s ease-in-out;
    }
    
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .subcategories-header {
      background: white;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .subcategories-title {
      font-size: 1.5em;
      font-weight: bold;
      color: #333;
    }
    
    .back-button {
      background: #667eea;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1em;
      transition: background 0.3s;
    }
    
    .back-button:hover {
      background: #5468d4;
    }
    
    .subcategory-card {
      background: white;
      padding: 15px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
      border: 2px solid transparent;
    }
    
    .subcategory-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.15);
      border-color: #667eea;
    }
    
    .subcategory-card.active {
      background: #667eea;
      color: white;
      border-color: #667eea;
    }
    
    .subcategory-name {
      font-weight: 600;
      text-align: center;
    }
    
    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üåü Santa Barbara 211</h1>
      <p>Find Community Resources Near You</p>
    </header>
    
    <div style="margin: 15px auto; max-width: 600px; padding: 10px; background: #f0f8ff; border-radius: 8px;">
      <label style="font-weight: bold; margin-right: 10px;">Your Location:</label>
      <input type="text" id="userZipCode" value="" placeholder="Enter ZIP" maxlength="5" 
             style="width: 80px; padding: 5px; margin-right: 10px; border: 1px solid #ccc; border-radius: 4px;"
             oninput="handleZipCodeInput(this.value)" />
      <button id="saveZipButton" onclick="saveZipCode()" 
              style="background: #28a745; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; margin-right: 10px; display: none;">
        Save
      </button>
      <button onclick="useCurrentLocation()" 
              style="background: #005191; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer;">
        üìç Use My Current Zip Code
      </button>
      <span id="locationStatus" style="margin-left: 10px; color: #666;"></span>
    </div>
    
    <div class="search-box">
      <input type="text" id="searchInput" placeholder="Search for resources..." />
    </div>
    
    <div class="categories" id="categories">
      <div class="loading">Loading categories...</div>
    </div>
    
    <div id="resultsSection" class="hidden">
      <div class="subcategories-header">
        <div class="subcategories-title" id="resultsTitle">Search Results</div>
        <button class="back-button" onclick="backToCategories()">‚Üê Back to Categories</button>
      </div>
      
      <div style="margin: 20px 0;">
        <select id="subcategoryDropdown" style="width: 100%; padding: 10px; font-size: 16px; border-radius: 5px; border: 2px solid #667eea;">
          <option value="">All Subcategories</option>
        </select>
      </div>
      
      <div class="resources" id="searchResults">
        <div class="loading">Loading results...</div>
      </div>
    </div>
    
    <div id="detailSection" class="hidden">
      <div class="subcategories-header">
        <div class="subcategories-title">Resource Details</div>
        <button class="back-button" onclick="backToList()">‚Üê Back to List</button>
      </div>
      
      <div id="resourceDetail" style="background: white; padding: 30px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);">
        <div class="loading">Loading details...</div>
      </div>
    </div>
    
    <div class="resources" id="resources">
      <div class="loading">Loading resources...</div>
    </div>
  </div>
  
  <script>
    const API_BASE = '/api';
    let allResources = [];
    let activeCategory = null;
    let activeSubcategory = null;
    let currentCategoryId = null;
    let userZipCode = localStorage.getItem('savedZipCode') || ''; // Load saved zip or start empty
    let savedZipCode = localStorage.getItem('savedZipCode') || ''; // Track the saved value
    
    // Load categories
    async function loadCategories() {
      try {
        const response = await fetch(`${API_BASE}/categories`);
        const categories = await response.json();
        displayCategories(categories);
      } catch (error) {
        console.error('Error loading categories:', error);
        document.getElementById('categories').innerHTML = '<div class="error">Failed to load categories</div>';
      }
    }
    
    // Display categories
    function displayCategories(categories) {
      const container = document.getElementById('categories');
      const icons = {
        'housing': 'üè†',
        'food': 'üçé',
        'healthcare': 'üè•',
        'mental-wellness': 'üß†',
        'substance-use': 'üíä',
        'children-family': 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶',
        'young-adults': 'üë•',
        'legal-assistance': '‚öñÔ∏è',
        'utilities': 'üí°',
        'transportation': 'üöå',
        'hygiene-household': 'üßº',
        'finance-employment': 'üíº',
        'education': 'üìö',
        'default': 'üìå'
      };
      
      container.innerHTML = categories.map(cat => `
        <div class="category-card" data-category="${cat.id}" data-category-name="${cat.name}" onclick="showSubcategories('${cat.id}', '${cat.name}')">
          <div class="category-icon">${icons[cat.icon] || icons.default}</div>
          <div class="category-name">${cat.name}</div>
          <div class="category-description">${cat.description || ''}</div>
        </div>
      `).join('');
    }
    
    // Load resources
    async function loadResources(search = '', category = '') {
      try {
        let url = `${API_BASE}/resources`;
        const params = new URLSearchParams();
        if (search) params.append('search', search);
        if (category) params.append('category', category);
        if (params.toString()) url += '?' + params.toString();
        
        const response = await fetch(url);
        const data = await response.json();
        // Handle both old array format and new paginated format
        const resources = Array.isArray(data) ? data : (data.resources || []);
        allResources = resources;
        displayResources(resources);
      } catch (error) {
        console.error('Error loading resources:', error, error.stack);
        document.getElementById('resources').innerHTML = `<div class="error">Failed to load resources: ${error.message}</div>`;
      }
    }
    
    // Helper function to strip HTML and truncate text
    function stripHtmlAndTruncate(text, maxLength = 250) {
      if (!text) return '';
      // Remove HTML tags and decode HTML entities
      const temp = document.createElement('div');
      temp.innerHTML = text;
      const plainText = temp.textContent || temp.innerText || '';
      // Truncate if needed
      return plainText.length > maxLength ? 
        plainText.substring(0, maxLength).trim() + '...' : 
        plainText;
    }
    
    // Handle zip code input changes
    function handleZipCodeInput(zipCode) {
      const saveButton = document.getElementById('saveZipButton');
      const normalizedZip = zipCode ? zipCode.replace(/\D/g, '').slice(0, 5) : '';
      
      if (normalizedZip.length === 5 && ZIP_CODE_DATA[normalizedZip]) {
        // Valid 5-digit zip code
        if (normalizedZip !== savedZipCode) {
          // Show Save/Update button if different from saved
          saveButton.style.display = 'inline-block';
          saveButton.textContent = savedZipCode ? 'Update' : 'Save';
        } else {
          // Hide button if same as saved
          saveButton.style.display = 'none';
        }
      } else {
        // Invalid or incomplete zip
        saveButton.style.display = 'none';
      }
    }
    
    // Save the zip code
    function saveZipCode() {
      const zipInput = document.getElementById('userZipCode');
      const zipCode = zipInput.value;
      const normalizedZip = zipCode ? zipCode.replace(/\D/g, '').slice(0, 5) : '';
      const saveButton = document.getElementById('saveZipButton');
      const statusEl = document.getElementById('locationStatus');
      
      if (normalizedZip.length === 5 && ZIP_CODE_DATA[normalizedZip]) {
        // Save to localStorage and update variables
        localStorage.setItem('savedZipCode', normalizedZip);
        savedZipCode = normalizedZip;
        userZipCode = normalizedZip;
        
        // Hide save button
        saveButton.style.display = 'none';
        
        // Show success message
        statusEl.textContent = '‚úÖ ZIP code saved';
        setTimeout(() => {
          statusEl.textContent = '';
        }, 2000);
        
        // Refresh display in all active views
        refreshDistancesInAllViews();
      }
    }
    
    // Update user location (called from other functions)
    function updateUserLocation(zipCode) {
      // Normalize zip code to 5 digits (remove non-digits and take first 5)
      const normalizedZip = zipCode ? zipCode.replace(/\D/g, '').slice(0, 5) : null;
      
      if (normalizedZip && normalizedZip.length === 5 && ZIP_CODE_DATA[normalizedZip]) {
        userZipCode = normalizedZip;
        document.getElementById('userZipCode').value = normalizedZip;
        document.getElementById('locationStatus').textContent = '‚úì Location updated';
        setTimeout(() => {
          document.getElementById('locationStatus').textContent = '';
        }, 2000);
        
        // Refresh display in all active views
        refreshDistancesInAllViews();
      } else {
        document.getElementById('locationStatus').textContent = '‚ùå Invalid zip code';
        setTimeout(() => {
          document.getElementById('locationStatus').textContent = '';
        }, 3000);
      }
    }
    
    // Refresh distances in all active views
    function refreshDistancesInAllViews() {
      // Refresh main resource list if visible (categories are HIDDEN when resources are shown)
      const resourcesEl = document.getElementById('resources');
      const categoriesEl = document.getElementById('categories');
      if (resourcesEl && categoriesEl && categoriesEl.classList.contains('hidden')) {
        if (allResources.length > 0) {
          displayResources(allResources);
        }
      }
      
      // Refresh search results if visible
      const searchResultsEl = document.getElementById('searchResults');
      const resultsSection = document.getElementById('resultsSection');
      if (searchResultsEl && resultsSection && !resultsSection.classList.contains('hidden')) {
        // If we have stored results, refresh them
        if (window.currentSearchResults) {
          displaySearchResults(window.currentSearchResults);
        }
      }
      
      // Refresh detail view if visible
      const detailSection = document.getElementById('detailSection');
      if (detailSection && !detailSection.classList.contains('hidden')) {
        // Re-fetch and display current detail
        if (window.currentDetailId) {
          showResourceDetail(window.currentDetailId);
        }
      }
    }
    
    // Use current GPS location
    function useCurrentLocation() {
      const statusEl = document.getElementById('locationStatus');
      statusEl.textContent = 'Getting your location...';
      
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          (position) => {
            const { latitude, longitude } = position.coords;
            const closestZip = window.findClosestZipCode(latitude, longitude);
            if (closestZip) {
              userZipCode = closestZip;
              document.getElementById('userZipCode').value = closestZip;
              statusEl.textContent = `‚úì Location set to ${closestZip}`;
              setTimeout(() => {
                statusEl.textContent = '';
              }, 3000);
              // Refresh display in all views
              refreshDistancesInAllViews();
            } else {
              statusEl.textContent = '‚ùå Could not determine zip code';
              setTimeout(() => {
                statusEl.textContent = '';
              }, 3000);
            }
          },
          (error) => {
            statusEl.textContent = '‚ùå Location access denied';
            setTimeout(() => {
              statusEl.textContent = '';
            }, 3000);
          }
        );
      } else {
        statusEl.textContent = '‚ùå Geolocation not supported';
        setTimeout(() => {
          statusEl.textContent = '';
        }, 3000);
      }
    }
    
    // Display resources
    function displayResources(resources) {
      const container = document.getElementById('resources');
      
      if (!resources || resources.length === 0) {
        container.innerHTML = '<div class="no-results">No resources found. Try a different search or category.</div>';
        return;
      }
      
      // Sort resources based on whether we have a user zip code
      let sortedResources = [...resources];
      if (userZipCode && window.calculateZipCodeDistance) {
        // Calculate distances for each resource
        sortedResources = sortedResources.map(resource => {
          const distance = resource.zipCode ? 
            window.calculateZipCodeDistance(userZipCode, resource.zipCode) : null;
          return { ...resource, calculatedDistance: distance };
        });
        
        // Sort by distance (nulls at the end)
        sortedResources.sort((a, b) => {
          if (a.calculatedDistance === null) return 1;
          if (b.calculatedDistance === null) return -1;
          return a.calculatedDistance - b.calculatedDistance;
        });
      } else {
        // Sort alphabetically by name if no user zip code
        sortedResources.sort((a, b) => {
          const nameA = a.name || '';
          const nameB = b.name || '';
          return nameA.localeCompare(nameB);
        });
      }
      
      container.innerHTML = sortedResources.map(resource => {
        const truncatedDescription = stripHtmlAndTruncate(resource.description, 250);
        const distance = resource.calculatedDistance !== undefined ? 
          resource.calculatedDistance : 
          (resource.zipCode && userZipCode && typeof window.calculateZipCodeDistance !== 'undefined' ? 
            window.calculateZipCodeDistance(userZipCode, resource.zipCode) : null);
        
        return `
          <div class="resource-card">
            <div class="resource-name" onclick="showResourceDetail('${resource.id}')">${resource.name}</div>
            ${distance !== null ? `<div style="color: #666; font-size: 0.9em; margin: 5px 0;">üìç ${distance} miles away</div>` : ''}
            ${truncatedDescription ? `<p class="resource-description">${truncatedDescription}</p>` : ''}
          </div>
        `;
      }).join('');
    }
    
    // Called when clicking a main category
    async function searchByCategory(categoryId, categoryName) {
      currentCategoryId = categoryId;
      activeCategory = categoryName;
      
      // Get category data for keyword search
      const categories = await loadCategoriesData();
      const categoryData = categories.find(c => c.id === categoryId);
      
      if (!categoryData) {
        console.error('Category not found:', categoryId);
        return;
      }
      
      // Hide categories and show results section
      document.getElementById('categories').classList.add('hidden');
      document.getElementById('resources').classList.add('hidden'); 
      document.getElementById('resultsSection').classList.remove('hidden');
      document.getElementById('resultsTitle').textContent = `${categoryName} Resources`;
      
      // Load subcategories for dropdown
      try {
        const subResponse = await fetch(`${API_BASE}/subcategories?categoryId=${categoryId}`);
        const subcategories = await subResponse.json();
        populateSubcategoryDropdown(subcategories);
        
        // Search by category keywords
        const keywords = categoryData.keywords ? categoryData.keywords.join(' ') : categoryName;
        const response = await fetch(`${API_BASE}/resources?keyword=${encodeURIComponent(keywords)}&limit=50`);
        const data = await response.json();
        // Handle both old array format and new paginated format
        const resources = Array.isArray(data) ? data : (data.resources || []);
        // Store results for refresh
        window.currentSearchResults = resources;
        displaySearchResults(resources);
        
        // Set up infinite scroll if there are more results
        if (data.hasMore) {
          setupInfiniteScroll(keywords, null, data.offset + resources.length);
        }
      } catch (error) {
        console.error('Error searching by category:', error, error.stack);
        document.getElementById('searchResults').innerHTML = `<div class="error">Failed to load resources: ${error.message}</div>`;
      }
    }
    
    // Called by the new showSubcategories wrapper
    window.showSubcategories = function(categoryId, categoryName) {
      searchByCategory(categoryId, categoryName);
    }
    
    // Populate subcategory dropdown
    function populateSubcategoryDropdown(subcategories) {
      const dropdown = document.getElementById('subcategoryDropdown');
      dropdown.innerHTML = '<option value="">All Subcategories</option>';
      
      if (subcategories && subcategories.length > 0) {
        subcategories.forEach(sub => {
          const option = document.createElement('option');
          option.value = sub.taxonomyCode || sub.id;
          option.textContent = sub.name;
          option.dataset.subcategoryId = sub.id;
          dropdown.appendChild(option);
        });
      }
      
      // Add change listener
      dropdown.onchange = async function() {
        const selectedValue = this.value;
        if (selectedValue) {
          // Search by taxonomy code
          const response = await fetch(`${API_BASE}/resources?taxonomyCode=${encodeURIComponent(selectedValue)}&keywordIsTaxonomyCode=true&limit=50`);
          const data = await response.json();
          // Handle both old array format and new paginated format
          const resources = Array.isArray(data) ? data : (data.resources || []);
          displaySearchResults(resources);
          
          // Set up infinite scroll if there are more results
          if (data.hasMore) {
            setupInfiniteScroll(null, selectedValue, data.offset + resources.length);
          }
        } else {
          // Search by category keywords again
          searchByCategory(currentCategoryId, activeCategory);
        }
      };
    }
    
    // Display search results
    function displaySearchResults(resources) {
      const container = document.getElementById('searchResults');
      
      if (!resources || resources.length === 0) {
        container.innerHTML = '<div class="no-results">No resources found</div>';
        return;
      }
      
      // Sort resources based on whether we have a user zip code
      let sortedResources = [...resources];
      if (userZipCode && window.calculateZipCodeDistance) {
        // Calculate distances for each resource
        sortedResources = sortedResources.map(resource => {
          const distance = resource.zipCode ? 
            window.calculateZipCodeDistance(userZipCode, resource.zipCode) : null;
          return { ...resource, calculatedDistance: distance };
        });
        
        // Sort by distance (nulls at the end)
        sortedResources.sort((a, b) => {
          if (a.calculatedDistance === null) return 1;
          if (b.calculatedDistance === null) return -1;
          return a.calculatedDistance - b.calculatedDistance;
        });
      } else {
        // Sort alphabetically by name if no user zip code
        sortedResources.sort((a, b) => {
          const nameA = a.name || '';
          const nameB = b.name || '';
          return nameA.localeCompare(nameB);
        });
      }
      
      container.innerHTML = sortedResources.map(res => {
        const truncatedDescription = stripHtmlAndTruncate(res.description, 250);
        const distance = res.calculatedDistance !== undefined ? 
          res.calculatedDistance : 
          (res.zipCode && userZipCode && typeof window.calculateZipCodeDistance !== 'undefined' ? 
            window.calculateZipCodeDistance(userZipCode, res.zipCode) : null);
        
        return `
          <div class="resource-card">
            <div class="resource-name" onclick="showResourceDetail('${res.id}')">${res.name}</div>
            ${distance !== null ? `<div style="color: #666; font-size: 0.9em; margin: 5px 0;">üìç ${distance} miles away</div>` : ''}
            ${truncatedDescription ? `<p class="resource-description">${truncatedDescription}</p>` : ''}
          </div>
        `;
      }).join('');
    }
    
    // Infinite scroll state
    let isLoadingMore = false;
    let currentOffset = 0;
    let currentKeyword = null;
    let currentTaxonomy = null;
    
    // Setup infinite scroll
    function setupInfiniteScroll(keyword = null, taxonomyCode = null, offset = 0) {
      currentKeyword = keyword;
      currentTaxonomy = taxonomyCode;
      currentOffset = offset;
      
      // Remove existing listener if any
      window.removeEventListener('scroll', handleScroll);
      
      // Add new scroll listener
      window.addEventListener('scroll', handleScroll);
    }
    
    // Handle scroll event for infinite loading
    async function handleScroll() {
      if (isLoadingMore) return;
      
      // Check if user scrolled to bottom
      if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 500) {
        isLoadingMore = true;
        
        // Show loading indicator
        const container = document.getElementById('searchResults');
        container.insertAdjacentHTML('beforeend', '<div id="loadingMore" class="loading">Loading more resources...</div>');
        
        try {
          let url = `${API_BASE}/resources?offset=${currentOffset}&limit=50`;
          
          if (currentKeyword) {
            url += `&keyword=${encodeURIComponent(currentKeyword)}`;
          } else if (currentTaxonomy) {
            url += `&taxonomyCode=${encodeURIComponent(currentTaxonomy)}&keywordIsTaxonomyCode=true`;
          }
          
          const response = await fetch(url);
          const data = await response.json();
          const resources = data.resources || [];
          
          // Remove loading indicator
          document.getElementById('loadingMore')?.remove();
          
          if (resources.length > 0) {
            // Append new resources
            appendSearchResults(resources);
            currentOffset += resources.length;
            
            // Continue listening if more results available
            if (!data.hasMore) {
              window.removeEventListener('scroll', handleScroll);
            }
          }
        } catch (error) {
          console.error('Error loading more resources:', error);
          document.getElementById('loadingMore')?.remove();
        }
        
        isLoadingMore = false;
      }
    }
    
    // Append more results (for infinite scroll)
    function appendSearchResults(resources) {
      const container = document.getElementById('searchResults');
      const newHTML = resources.map(res => {
        const truncatedDescription = stripHtmlAndTruncate(res.description, 250);
        const distance = res.zipCode && typeof window.calculateZipCodeDistance !== 'undefined' ? 
          window.calculateZipCodeDistance(userZipCode, res.zipCode) : null;
        
        return `
          <div class="resource-card">
            <div class="resource-name" onclick="showResourceDetail('${res.id}')">${res.name}</div>
            ${distance !== null ? `<div style="color: #666; font-size: 0.9em; margin: 5px 0;">üìç ${distance} miles away</div>` : ''}
            ${truncatedDescription ? `<p class="resource-description">${truncatedDescription}</p>` : ''}
          </div>
        `;
      }).join('');
      
      container.insertAdjacentHTML('beforeend', newHTML);
    }
    
    // Back to categories
    window.backToCategories = function() {
      document.getElementById('resultsSection').classList.add('hidden');
      document.getElementById('detailSection').classList.add('hidden');
      document.getElementById('categories').classList.remove('hidden');
      document.getElementById('resources').classList.remove('hidden');
      activeCategory = null;
      activeSubcategory = null;
      currentCategoryId = null;
      // Remove infinite scroll listener
      window.removeEventListener('scroll', handleScroll);
      loadResources();
    }
    
    // Show resource detail
    window.showResourceDetail = async function(resourceId) {
      // Store current detail ID for refresh
      window.currentDetailId = resourceId;
      
      // Hide other sections
      document.getElementById('categories').classList.add('hidden');
      document.getElementById('resources').classList.add('hidden');
      document.getElementById('resultsSection').classList.add('hidden');
      document.getElementById('detailSection').classList.remove('hidden');
      
      const detailContainer = document.getElementById('resourceDetail');
      detailContainer.innerHTML = '<div class="loading">Loading resource details...</div>';
      
      try {
        // Fetch detailed information from the API
        const response = await fetch(`${API_BASE}/resources/${resourceId}/details`);
        const detail = await response.json();
        
        // Calculate distance if zip code is available
        const distance = detail.zipCode && typeof window.calculateZipCodeDistance !== 'undefined' ? 
          window.calculateZipCodeDistance(userZipCode, detail.zipCode) : null;
        
        // Display detailed information
        detailContainer.innerHTML = `
          <div style="margin-bottom: 30px;">
            <h1 style="font-size: 2em; color: #333; margin-bottom: 10px;">${detail.name}</h1>
            ${detail.organization ? `<h2 style="font-size: 1.2em; color: #666; margin-bottom: 5px;">Organization: ${detail.organization}</h2>` : ''}
            ${detail.siteName ? `<h3 style="font-size: 1em; color: #888;">Site: ${detail.siteName}</h3>` : ''}
            ${distance !== null ? `<div style="background: #e0f2ff; color: #005191; padding: 8px 15px; border-radius: 5px; margin-top: 10px; display: inline-block; font-weight: bold;">üìç ${distance} miles from your location (${userZipCode})</div>` : ''}
          </div>
          
          ${detail.description ? `
            <div style="background: #f7f7f7; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
              <h3 style="color: #005191; margin-bottom: 10px;">Service Description</h3>
              <p style="line-height: 1.6; color: #333;">${detail.description}</p>
            </div>
          ` : ''}
          
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px;">
            ${detail.address && detail.address.full ? `
              <div style="background: white; padding: 15px; border-left: 4px solid #667eea; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                <h4 style="color: #667eea; margin-bottom: 10px;">üìç Location</h4>
                <p>${detail.address.street}</p>
                ${detail.address.street2 ? `<p>${detail.address.street2}</p>` : ''}
                <p>${detail.address.city}, ${detail.address.state} ${detail.address.postalCode}</p>
              </div>
            ` : ''}
            
            ${detail.contact ? `
              <div style="background: white; padding: 15px; border-left: 4px solid #667eea; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                <h4 style="color: #667eea; margin-bottom: 10px;">üìû Contact</h4>
                ${detail.contact.phone ? `<p><strong>Phone:</strong> <a href="tel:${detail.contact.phone}">${detail.contact.phone}</a></p>` : ''}
                ${detail.contact.tty ? `<p><strong>TTY:</strong> ${detail.contact.tty}</p>` : ''}
                ${detail.contact.crisis ? `<p><strong>Crisis:</strong> <a href="tel:${detail.contact.crisis}">${detail.contact.crisis}</a></p>` : ''}
                ${detail.contact.fax ? `<p><strong>Fax:</strong> ${detail.contact.fax}</p>` : ''}
                ${detail.contact.email ? `<p><strong>Email:</strong> <a href="mailto:${detail.contact.email}">${detail.contact.email}</a></p>` : ''}
                ${detail.contact.website ? `<p><strong>Website:</strong> <a href="${detail.contact.website}" target="_blank" rel="noopener">${detail.contact.website}</a></p>` : ''}
              </div>
            ` : ''}
          </div>
          
          ${detail.hours ? `
            <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
              <h4 style="color: #856404; margin-bottom: 10px;">üïê Hours of Operation</h4>
              <p style="white-space: pre-line;">${detail.hours}</p>
            </div>
          ` : ''}
          
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
            ${detail.eligibility ? `
              <div style="background: #f0f8ff; padding: 15px; border-radius: 8px;">
                <h4 style="color: #004085; margin-bottom: 10px;">‚úì Eligibility</h4>
                <p>${detail.eligibility}</p>
              </div>
            ` : ''}
            
            ${detail.applicationProcess ? `
              <div style="background: #f0f8ff; padding: 15px; border-radius: 8px;">
                <h4 style="color: #004085; margin-bottom: 10px;">üìù Application Process</h4>
                <p>${detail.applicationProcess}</p>
              </div>
            ` : ''}
            
            ${detail.documentsRequired ? `
              <div style="background: #fff5f5; padding: 15px; border-radius: 8px;">
                <h4 style="color: #721c24; margin-bottom: 10px;">üìã Documents Required</h4>
                <p>${detail.documentsRequired}</p>
              </div>
            ` : ''}
            
            ${detail.fees ? `
              <div style="background: #d4edda; padding: 15px; border-radius: 8px;">
                <h4 style="color: #155724; margin-bottom: 10px;">üíµ Fees</h4>
                <p>${detail.fees}</p>
              </div>
            ` : ''}
            
            ${detail.serviceArea ? `
              <div style="background: #e2e3e5; padding: 15px; border-radius: 8px;">
                <h4 style="color: #383d41; margin-bottom: 10px;">üåç Service Area</h4>
                <p>${detail.serviceArea}</p>
              </div>
            ` : ''}
            
            ${detail.languages && detail.languages.length > 0 ? `
              <div style="background: #e2e3e5; padding: 15px; border-radius: 8px;">
                <h4 style="color: #383d41; margin-bottom: 10px;">üó£ Languages</h4>
                <p>${detail.languages.join(', ')}</p>
              </div>
            ` : ''}
            
            ${detail.accessibility ? `
              <div style="background: #e2e3e5; padding: 15px; border-radius: 8px;">
                <h4 style="color: #383d41; margin-bottom: 10px;">‚ôø Accessibility</h4>
                <p>${detail.accessibility}</p>
              </div>
            ` : ''}
          </div>
          
          ${detail.notes ? `
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 20px;">
              <h4 style="color: #495057; margin-bottom: 10px;">üìå Additional Information</h4>
              <p>${detail.notes}</p>
            </div>
          ` : ''}
          
          ${detail.lastUpdated ? `
            <p style="text-align: right; color: #999; margin-top: 20px; font-size: 0.9em;">
              Last Updated: ${detail.lastUpdated}
            </p>
          ` : ''}
        `;
      } catch (error) {
        console.error('Error loading resource details:', error);
        detailContainer.innerHTML = '<div class="error">Failed to load resource details. Please try again.</div>';
      }
    }
    
    // Back to list from detail view
    window.backToList = function() {
      document.getElementById('detailSection').classList.add('hidden');
      
      // Determine which list to go back to
      if (currentCategoryId) {
        document.getElementById('resultsSection').classList.remove('hidden');
      } else {
        document.getElementById('categories').classList.remove('hidden');
        document.getElementById('resources').classList.remove('hidden');
      }
    }
    
    // Load categories data
    async function loadCategoriesData() {
      try {
        const response = await fetch(`${API_BASE}/categories`);
        return await response.json();
      } catch (error) {
        console.error('Error loading categories data:', error);
        return [];
      }
    }
    
    // Search functionality
    let searchTimeout;
    document.getElementById('searchInput').addEventListener('input', (e) => {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => {
        // If in results view, go back to main view
        if (currentCategoryId) {
          backToCategories();
        }
        // Clear category selection when searching
        document.querySelectorAll('.category-card').forEach(c => c.classList.remove('active'));
        activeCategory = null;
        loadResources(e.target.value);
      }, 300);
    });
    
    // Initialize
    loadCategories();
    loadResources();
    
    // Initialize zip code field from localStorage
    if (userZipCode) {
      document.getElementById('userZipCode').value = userZipCode;
    }
  </script>
</body>
</html>